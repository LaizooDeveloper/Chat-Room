<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room - <%= room %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h4 class="mb-0">💬 Room: <%= room %></h4>
            <div>
                <span class="me-3">👤 <%= username %></span>
                <button id="themeToggle" class="btn btn-sm btn-outline-secondary">🌙 Dark</button>
            </div>
        </div>

        <!-- Messages area -->
        <div id="messages" class="chat-box mb-3"></div>

        <!-- Message form -->
        <form id="chatForm" class="d-flex">
            <input id="msg" class="form-control me-2" type="text" placeholder="Type a message..." required>
            <button class="btn btn-success">Send</button>
        </form>
    </div>

    <!-- Notification sound -->
    <audio id="notifySound" src="/sounds/notify.mp3" preload="auto"></audio>

    <script>
        const socket = io();
        const username = "<%= username %>";
        const room = "<%= room %>";

        // Join room
        socket.emit("joinRoom", { username, room });

        // Receive messages
        socket.on("message", (data) => {
            const messagesDiv = document.getElementById("messages");
            const msgDiv = document.createElement("div");

            const isMine = data.user === username;
            const isSystem = data.user === "System";

            msgDiv.className = `chat-bubble ${isSystem ? "system" : isMine ? "mine" : "other"}`;
            msgDiv.innerHTML = isSystem 
                ? `<div class="chat-text">⚙️ ${data.text}</div><div class="chat-time">${data.time || ""}</div>`
                : `
                    <div class="chat-user">${data.user}</div>
                    <div class="chat-text">${data.text}</div>
                    <div class="chat-time">${data.time || ""}</div>
                  `;

            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (!isMine && !isSystem) {
                document.getElementById("notifySound").play();
            }
        });

        // Send message
        document.getElementById("chatForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const msg = document.getElementById("msg").value;
            socket.emit("chatMessage", { username, room, message: msg });
            document.getElementById("msg").value = "";
        });

        // Dark/Light mode toggle
        const themeToggle = document.getElementById("themeToggle");
        if (localStorage.getItem("theme") === "dark") {
            document.body.classList.add("dark");
            themeToggle.textContent = "☀️ Light";
        }
        themeToggle.addEventListener("click", () => {
            document.body.classList.toggle("dark");
            if (document.body.classList.contains("dark")) {
                localStorage.setItem("theme", "dark");
                themeToggle.textContent = "☀️ Light";
            } else {
                localStorage.setItem("theme", "light");
                themeToggle.textContent = "🌙 Dark";
            }
        });
    </script>
</body>
</html>
